(function(){$(function(){var g,d;g=new GLIFFY.Message(function(j){document.getElementById("editor").contentWindow.postMessage(j,"*")},function(j){return j.source===document.getElementById("editor").contentWindow});g.registerReceiveActions({getShapes:function(k,l,j){$.getJSON("data/shapes.json",l,function(n,o,m){j(n.status,n.responseText)})},getStencils:function(k,l,j){$.getJSON("data/stencils.json",l,function(n,o,m){j(n.status,n.responseText)})},setTitle:function(k,l,j){if(k){document.title="Gliffy Diagrams - "+k}else{document.title="Gliffy Diagrams"}},hideSplash:function(k,l,j){$("#splash").hide();$("#editor").focus()},ready:function(k,l,j){g.send("version",chrome.runtime.getManifest().version);i(function(){if(GLIFFY.ENV.useIdentityApi==true){GLIFFY.googleDrive.init(d)}if(window.launch){if(window.launch.fileEntry){GLIFFY.IO.newGonHandler(window.launch.fileEntry,function(){l(window.launch.document)})}else{l(window.launch.document)}}else{if(window.launchData){l(launchData.intent.data)}else{l(null)}}})},updateAccount:function(k,l,j){c(k)},promptSaveAs:function(k,l,j){GLIFFY.IO.promptSaveGonFile(l,j,function(){l({cancelled:true})})},saveTemp:function(k,l,j){GLIFFY.IO.writeTempGonFile(k,l,j)},save:function(k,l,j){GLIFFY.IO.writeGonFile(k,function(m){GLIFFY.IO.removeTempGonFile(k,function(){},function(n,o){console.error(o)});l(m)},j)},open:function(k,l,j){GLIFFY.IO.openGonFile(l,j)},newWindow:function(l,n,k){try{if(l){var j=GLIFFY.IO.getGonFileHandler(l);GLIFFY.desktopUtils.openAppWindow({document:l,fileEntry:j.fileEntry},n);j.close()}else{GLIFFY.desktopUtils.openAppWindow(null,n)}}catch(m){k(400,m.message);throw m}},"export":function(k,l,j){chrome.fileSystem.chooseEntry({type:"saveFile",accepts:[{extensions:[k.ext]}],suggestedName:k.name.substr(0,k.name.lastIndexOf("."))||k.name},function(m){chrome.fileSystem.getWritableEntry(m,function(n){n.createWriter(function(p){p.onwriteend=function(q){if(this.error){j()}else{l()}};var o=new Blob([window.dataURLtoBlob(k.imageBase64)],{type:k.contentType});p.write(o)})})})},getLocalStorage:function(k,l,j){chrome.storage.local.get(k,l)},setLocalStorage:function(k,l,j){chrome.storage.local.set(k,l)},updateDesktopData:function(k,l,j){chrome.storage.local.get("gliffyDesktop",function(m){k.gliffyDesktop=$.extend(m.gliffyDesktop,k.gliffyDesktop);chrome.storage.local.set(k,l)})},manual:function(k,l,j){GLIFFY.desktopUtils.openWindow({url:"static.html?page=Gliffy_User_Manual_Gliffy_Online.html",id:"GliffyManual"})},discardAutosave:function(k,l,j){if(k.urls.tempId!==undefined&&k.urls.tempId!==null){GLIFFY.IO.removeTempGonFile(k,function(){},function(m,n){console.error(n)})}},close:function(k,l,j){if(k.urls.tempId!==undefined&&k.urls.tempId!==null){GLIFFY.IO.removeTempGonFile(k,function(){window.close()},function(m,n){console.error(n);window.close()})}else{window.close()}},revert:function(k,l,j){GLIFFY.IO.removeTempGonFile(k,function(){if(k.urls.path){GLIFFY.IO.readGonFile(k,l,j)}else{window.close()}},function(m,n){console.error(n);window.close()})},eula:function(k,l,j){GLIFFY.desktopUtils.openWindow({url:"static.html?page=Gliffy_End_User_License_Agreement_Gliffy_Plugins.html",id:"GliffyEula"})},feedback:function(k,l,j){$.post("https://go.gliffy.com/go/api/user/sendFeedback?appId=e1dcc9a8-4bf3-4b8c-976e-f3d84de7ba5a",k)},gdriveSetupGuide:function(k,l,j){GLIFFY.desktopUtils.openWindow({url:"static.html?page=GDrive_Setup.html",id:"GDriveSetup"})},getFolders:function(k,l,j){console.log("getFolders");console.log(k);l({data:"Root",attr:{id:"ROOT"},children:[{data:"Bob",attr:{id:"bob"},children:[{data:"Dan",attr:{id:"dan"}}]},{data:"Jim",attr:{id:"jim"}}]})},createFolder:function(k,l,j){console.log("createFolder");console.log(k);l({id:k.folderName})},deleteFolder:function(k,l,j){console.log("deleteFolder");console.log(k);l({success:true})},getDocuments:function(k,l,j){console.log("getDocuments");console.log(k);l([{name:"My Cool Diagram",isFavorite:true,lastModified:1350950400,lastModifiedFriendly:"October 23, 2012",createDate:1212969600,createDateFriendly:"June 09, 2008",isPublic:false,createdBy:"Jack Muir",lastModifiedBy:"Han Lee",currentlyEditedBy:"Han Lee",urls:{thumbnail:"/go/view/90209.png?size=thumbnail&ts=-408129242",open:"/go/api/diagram.json?diagramId=90000",update:"/go/api/diagram.json?diagramId=90000"},"read-only":false},{name:"Aardvark Migration",isFavorite:true,lastModified:1352678400,lastModifiedFriendly:"November 12, 2012",createDate:1342828800,createDateFriendly:"July 21, 2012",isPublic:true,createdBy:"Clint Dickson",lastModifiedBy:"Kerry Liu",urls:{thumbnail:"/go/view/90172.png?size=thumbnail&ts=-408129242",open:"/go/api/diagram.json?diagramId=90001",update:"/go/api/diagram.json?diagramId=90000"},"read-only":false},{name:"BPMN",isFavorite:false,lastModified:1338854400,lastModifiedFriendly:"June 05, 2012",createDate:1334188800,createDateFriendly:"April 12, 2012",isPublic:false,createdBy:"Todd",lastModifiedBy:"Rocco",urls:{thumbnail:"/go/view/90000.png?size=thumbnail&ts=-408129242",open:"/go/api/diagram.json?diagramId=90001",update:"/go/api/diagram.json?diagramId=90000"},"read-only":false},{name:"Floorplan of a really nice house on Mars that has big chickens in the garage and a small car in the yard",isFavorite:false,lastModified:1233792000,lastModifiedFriendly:"February 05, 2009",createDate:1231718400,createDateFriendly:"January 12, 2009",isPublic:true,createdBy:"Todd",lastModifiedBy:"Eric Chiang",urls:{thumbnail:"/go/view/90004.png?size=thumbnail&ts=-408129242",open:"/go/api/diagram.json?diagramId=90001",update:"/go/api/diagram.json?diagramId=90000"},"read-only":false},{name:"BPMN 2",isFavorite:false,lastModified:1272326400,lastModifiedFriendly:"April 27, 2010",createDate:1193788800,createDateFriendly:"October 31, 2007",isPublic:false,createdBy:"Ron",lastModifiedBy:"Carole",urls:{thumbnail:"/go/view/90001.png?size=thumbnail&ts=-408129242",open:"/go/api/diagram.json?diagramId=90001",update:"/go/api/diagram.json?diagramId=90000"},"read-only":false}])}});function i(j){chrome.storage.local.get("gliffyDesktop",function(k){if(!k.gliffyDesktop){k.gliffyDesktop={cid:h(),initCount:1,name:"Trial User",productType:"GO_DESKTOP_BETA",isTrial:true,installDate:(new Date()).getTime()}}else{k.gliffyDesktop.initCount++}chrome.storage.local.set(k,function(){d=k.gliffyDesktop;f(j)})})}function e(j){if(GLIFFY.ENV.useIdentityApi&&chrome&&chrome.identity){chrome.identity.getAuthToken({interactive:true},function(k){var l=new XMLHttpRequest();l.open("GET","https://www.googleapis.com/oauth2/v1/userinfo?alt=json");l.setRequestHeader("Authorization","Bearer "+k);l.onload=function(n){if(this.status!=200){b(d,j);return}var m=JSON.parse(this.response);c({name:m.name,email:m.email,authToken:k},function(){b(d,j)})};l.send()})}else{b(d,j)}}function b(j,k){g.send("identity",j);if(k){k()}}function h(){var j="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(m){var l=Math.random()*16|0,k=m=="x"?l:(l&3|8);return k.toString(16)});return j}function f(j){$.ajax({url:"https://go.gliffy.com/go/api/desktop/register.json",type:"POST",contentType:"application/json",data:JSON.stringify(d),dataType:"json",success:function(k){c({productType:k.productType,driveEnabled:k.driveEnabled,lck:k.lck,lcb:k.lcb,tid:k.tid})}});e(j)}function c(j,k){chrome.storage.local.get("gliffyDesktop",function(l){for(var m in j){l.gliffyDesktop[m]=j[m]}chrome.storage.local.set(l,function(){d=l.gliffyDesktop;if(k){k()}})})}function a(j){var k=cryptico.encrypt(JSON.stringify(j),"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtDrnHkG02v/TI8j2wK9u\n371HMb/aGv2QGczldSgZXNbMePmpyr1MBTD0pOJICdBdMZaGmigRU7FiiRd6Zxcr\nZfxR42uzjS7vwY3uCRKrxtyBjpVR6icBkxhO1qf7e7Kt6rWvCpG5AyMqUiOG3p31\ngSz9uO0wc3pgrB26Z808u4gtKttXXxn2ucE8JBg0KjUQ0y8RTN4eLlrUAjCtRqQC\nAqcQwtmpaTBG9j+c435lLbA24SLhFTU/TN1FChL0TXX3NCAgJkws7Ahmepz4035H\nKkCH5pWoSS5UshjHzapWV9M5RKTCX2AnwqRTYjveFL7Sonx00Hspp93C0Spqe8T/\nVQIDAQAB");return k.cipher}});(function(){window.GLIFFY=window.GLIFFY||{};window.GLIFFY.googleDrive={DOCLIST_FEED:"https://docs.google.com/feeds/default/private/full/",__supportsSyncFileSystem:chrome&&chrome.syncFileSystem,username:null,init:function(a){this.checkAuth(a,function(b){this.__authToken=b;if(GLIFFY.ENV.useSyncFileSystemApi&&this.__supportsSyncFileSystem){this.openSyncableFileSystem()}else{this.openTemporaryFileSystem()}}.bind(this))},checkAuth:function(a,b){if(a.authToken){b&&b(a.authToken)}else{chrome.experimental.identity.getAuthToken({interactive:true},function(c){b&&b(c)})}},onFileSystemOpened:function(a){this.__filesystem=a;console.log("Got FileSystem:"+a.name);this.showUsage();if(GLIFFY.ENV.useIdentityApi){this.getDocumentList()}},openTemporaryFileSystem:function(){webkitRequestFileSystem(TEMPORARY,1024,function(a){this.onFileSystemOpened(a)}.bind(this),function(a){console.log("Error opening Temporary Filesystem - "+a.code)})},openSyncableFileSystem:function(){if(!chrome||!chrome.syncFileSystem||!chrome.syncFileSystem.requestFileSystem){console.log("Syncable FileSystem is not supported in your environment.");return}chrome.syncFileSystem.requestFileSystem(function(a){if(chrome.runtime.lastError){console.log("requestFileSystem: "+chrome.runtime.lastError.message);return}this.onFileSystemOpened(a)}.bind(this))},isSyncable:function(){return this.__filesystem.name.indexOf("Syncable")!=-1},showUsage:function(){if(this.isSyncable&&chrome&&chrome.syncFileSystem){chrome.syncFileSystem.getUsageAndQuota(this.__filesystem,function(a){if(chrome.runtime.lastError){console.log("getUsageAndQuota: "+chrome.runtime.lastError.message);return}console.log("Usage:"+GLIFFY.desktopUtils.formatSize(a.usageBytes))}.bind(this));return}webkitStorageInfo.queryUsageAndQuota(this.__filesystem,function(b,a){console.log("Usage:"+GLIFFY.desktopUtils.formatSize(b))}.bind(this))},getDocumentList:function(b,a){var c=b||this.DOCLIST_FEED+"?"+GLIFFY.desktopUtils.stringify({alt:"json"});if(a){this.makeRequest("GET",c,a.bind(this))}else{this.makeRequest("GET",c,this.logResponse.bind(this))}},makeRequest:function(a,b,h,f,d){var e=f||null;var c=d||{};var i=new XMLHttpRequest();i.open(a,b,true);i.setRequestHeader("Authorization","Bearer "+this.__authToken);i.setRequestHeader("GData-Version","3.0");for(var g in c){i.setRequestHeader(g,c[g])}i.onload=function(j){h(i.response,i)};i.onerror=function(j){console.log(this,this.status,this.response,this.getAllResponseHeaders())};i.send(e)},logResponse:function(a,b){}}}())}());