!function(){function a(e){var o=e,a=null,n="audio/webm";void 0!==window.InstallTrigger&&(n="audio/ogg");var s=null,r=!!window.opera||0<=navigator.userAgent.indexOf(" OPR/"),i=!!window.chrome&&!r,c=void 0!==window.InstallTrigger,u=!1,d=null,l=this;this.start=function(e){if(u)return!0;u=!0;var r=window.MediaStream;if(void 0===r&&"undefined"!=typeof webkitMediaStream&&(r=webkitMediaStream),void 0===r||!r)return console.error("_MediaStream === 'undefined'"),!1;if(o.getAudioTracks().length<=0)return console.error("_user_media_stream.getAudioTracks().length <= 0"),!1;navigator.mozGetUserMedia?(a=new r).addTrack(o.getAudioTracks()[0]):a=new r(o.getAudioTracks());var t={mimeType:n};!function(){if(c)return!0;if(!i)return!1;var e=-1,r=navigator.userAgent;console.log(r),-1!==(e=r.indexOf("Chrome"))&&(r=r.substring(e+7)),-1!==(e=r.indexOf(";"))&&(r=r.substring(0,e)),-1!==(e=r.indexOf(" "))&&(r=r.substring(0,e));var t=parseInt(""+r,10);return isNaN(t)&&(t=parseInt(navigator.appVersion,10)),console.log(t),49<=t}()&&(t="video/vp8");try{s=new MediaRecorder(a,t)}catch(e){s=new MediaRecorder(a)}if(!s||"canRecordMimeType"in s&&!1===s.canRecordMimeType(n))return console.warn("MediaRecorder API seems unable to record mimeType:",n),!1;s.ondataavailable=function(e){if(u){var r={status:0,data:new Blob([e.data],{type:n})};e.data&&e.data.size&&!(e.data.size<26800)||(r={status:-1,data:"Your Browser Can Not Record Audio"}),l.ondataavailable(r)}else console.log("MediaRecorderWrapper record have stopped.")},s.onerror=function(e){console.error(e.name),l.ondataavailable({status:-1,data:"Your Browser Can Not Record Audio"}),s&&s.stop()};try{s.start(36e5)}catch(e){return console.error(e),!1}return d=setInterval(function(){u&&s&&"recording"===s.state&&s.requestData()},e),!0},this.stop=function(){if(console.log("MediaRecorderWrapper stop"),u&&(u=!1,d&&(clearInterval(d),d=null),s&&"recording"===s.state)){s.stop();try{o.getAudioTracks()[0].stop()}catch(e){console.error(e)}}},this.ondataavailable=function(e){console.log("recorded-blob",e)}}var n=function(){this._server_url="https://api.acrcloud.com/v1/aha-music/identify",this._params={},this._audio_recorder=function(){var e=!1,o=null;return{start:function(t){console.log("AudioRecorder start"),e?console.log("_is_recording="+e):(e=!0,chrome.tabCapture.capture({audio:!0,video:!1},function(e){try{var r=new(window.AudioContext||window.webkitAudioContext);r.createMediaStreamSource(e).connect(r.destination),(o=new a(e)).ondataavailable=function(e){t.record_callback(e)},o.start(8e3)||t.record_callback({status:-1,data:"Your Browser Can Not Record Audio"})}catch(e){console.log(e),t.record_callback({status:-1,data:"Your Browser Can Not Record Audio, Please Try the Old Version Chrome or [Opera Browser], This May Be the Latest version of Chrome's Bug on Windows."})}}))},stop:function(){console.log("AudioRecorder stop"),null!=o&&o.stop(),e=!1},is_recording:function(){return e}}}(),this._storage_helper=function(){var r=[],t="";return chrome.runtime.onInstalled.addListener(function(e){chrome.storage.sync.get("history_datas",function(e){var r=e.history_datas;r&&0<r.length&&chrome.storage.local.set({history_datas:r}),chrome.storage.sync.set({history_datas:[]})})}),chrome.storage.local.get("history_datas",function(e){r=(r=e.history_datas)||[],!0}),chrome.storage.sync.get("device_id",function(e){var r=e.device_id;r?t=r:(t=Math.random()+""+(new Date).getTime(),chrome.storage.sync.set({device_id:t},function(){console.log("storage set")}))}),{get:function(){return r},set:function(e){r.unshift(e),chrome.storage.local.set({history_datas:r},function(){console.log(chrome.runtime.lastError)})},clear:function(){chrome.storage.local.set({history_datas:[]},function(){r=[]})},get_device_id:function(){return t}}}(),this._is_recognizing=!1;var d=this;function l(t,e){var r=chrome.i18n.getUILanguage();r=r||navigator.language;var o=this._server_url,a=navigator.userAgent,n=this._storage_helper.get_device_id(),s=new FormData;for(var i in d._params)s.append(i,d._params[i]);var c=chrome.runtime.getManifest(),u=chrome.runtime.id;console.log(u),s.append("token",e),s.append("sample_bytes",t.size),s.append("sample",t),s.append("timestamp",(new Date).getTime()),s.append("local_lan",r),s.append("browser_version",a),s.append("device_id",n),s.append("version",c.version),s.append("app_id",u),$.ajax({type:"POST",url:o,data:s,timeout:15e3,dataType:"json",processData:!1,contentType:!1,success:function(e){if(console.log(e),0==e.status){var r=e.data[0];r.timestamp=(new Date).getTime(),r.tab_url=d._params.tab_url,chrome.runtime.sendMessage({cmd:"popup_parse_result",result:{status:0,msg:"",data:r}}),d._storage_helper.set(r),d.reload()}else-2==e.status?function(r){chrome.identity.getAuthToken({interactive:!0},function(e){chrome.runtime.lastError?(console.log(chrome.runtime.lastError.message),chrome.runtime.sendMessage({cmd:"popup_login"})):l(r,e)})}(t):-3==e.status?chrome.runtime.sendMessage({cmd:"popup_update_version",result:{status:-1,msg:e.msg}}):chrome.runtime.sendMessage({cmd:"popup_error",result:{status:-1,msg:e.msg}})},error:function(e,r){console.log(e);var t="HTTP Error (Code = "+r+")";"timeout"==r&&(t="Network Timeout"),chrome.runtime.sendMessage({cmd:"popup_error",result:{status:-1,msg:t}})}})}return this.record_callback=function(e){d.stop(),0==e.status?l(e.data,"no_login"):chrome.runtime.sendMessage({cmd:"popup_error",result:{status:-1,msg:e.data}})},this.start=function(e){d._is_recognizing||(d._is_recognizing=!0,e&&(d._params=e),_audio_recorder.start(d))},this.stop=function(){d._is_recognizing&&(d._audio_recorder&&d._audio_recorder.stop(),d._is_recognizing=!1)},this.reload=function(){chrome.runtime.sendMessage({cmd:"popup_reload",result:{status:0,msg:"",recognize_status:d._is_recognizing,data:d._storage_helper.get()}})},this.init=function(){chrome.runtime.sendMessage({cmd:"popup_init",result:{status:0,msg:"",recognize_status:d._is_recognizing,data:d._storage_helper.get()}})},this.clear_history=function(){d._storage_helper.clear(),chrome.runtime.sendMessage({cmd:"popup_reload",result:{status:0,msg:"",recognize_status:d._is_recognizing,data:[]}})},d}();chrome.windows.onRemoved.addListener(function(e){chrome.notifications.clear("clear_history")}),chrome.runtime.onMessage.addListener(function(e,r,t){switch(e.cmd){case"background_start":chrome.tabs.query({active:!0,currentWindow:!0},function(e){if(e.length<1)return console.error("no select tab"),void chrome.runtime.sendMessage({cmd:"popup_error",result:{status:-1,msg:"Please Select One Tab."}});var r=e[0],o=r.url,a=r.title;r.audible?chrome.identity.getProfileUserInfo(function(e){var r="",t="";chrome.runtime.lastError?console.log(chrome.runtime.lastError.message):(r=e.email,t=e.id),n.start({tab_url:o,email:r,google_id:t,tab_title:a})}):chrome.runtime.sendMessage({cmd:"popup_error",result:{status:-1,msg:"No Sound Playing in Current Tab"}})});break;case"background_cancel":n&&n.stop();break;case"background_reload":n&&n.reload();break;case"background_init":n&&n.init();break;case"background_clear_history":console.log("background_clear_history"),chrome.notifications.create("clear_history",{buttons:[{title:"Yes"},{title:"No"}],title:"Confirm",message:"Do you want to clear history?",type:"basic",requireInteraction:!0,iconUrl:"../../icons/icon.png"},function(e){setTimeout(function(){chrome.notifications.clear(e)},1e4),chrome.notifications.onButtonClicked.addListener(function(e,r){0==r&&n&&n.clear_history(),chrome.notifications.clear(e)})})}})}();
